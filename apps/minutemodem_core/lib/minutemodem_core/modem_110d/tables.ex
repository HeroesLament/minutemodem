defmodule MinuteModemCore.Modem110D.Tables do
  @moduledoc """
  MIL-STD-188-110D Appendix D parameter tables.

  All tables are direct transcriptions from the spec.
  """

  import Bitwise

  # ===========================================================================
  # Table D-I: Symbol Rates and Sub-Carrier Frequencies
  # ===========================================================================

  @symbol_rates %{
    3 => 2400,
    6 => 4800,
    9 => 7200,
    12 => 9600,
    15 => 12000,
    18 => 14400,
    21 => 16800,
    24 => 19200,
    30 => 24000,
    36 => 28800,
    42 => 33600,
    48 => 38400
  }

  @doc "Symbol rate for given bandwidth (kHz)"
  def symbol_rate(bw_khz), do: Map.fetch!(@symbol_rates, bw_khz)

  @doc "Sub-carrier frequency: 300 + (BW_Hz / 2)"
  def subcarrier(bw_khz), do: 300 + bw_khz * 1000 / 2

  @doc "All supported bandwidths"
  def bandwidths, do: Map.keys(@symbol_rates) |> Enum.sort()

  # ===========================================================================
  # Table D-XIII: Walsh Sequence Length in Preamble
  # ===========================================================================

  @walsh_lengths %{
    3 => 32,
    6 => 64,
    9 => 96,
    12 => 128,
    15 => 160,
    18 => 192,
    21 => 224,
    24 => 256
  }

  @doc "Walsh sequence length for preamble channel symbols"
  def walsh_length(bw_khz), do: Map.fetch!(@walsh_lengths, bw_khz)

  # ===========================================================================
  # Table D-XI: Unknown (Data) Symbols per Frame (U)
  # ===========================================================================

  # {waveform, bandwidth} => U
  @data_symbols %{
    # Waveform 1 - BPSK
    {1, 3} => 48, {1, 6} => 96, {1, 9} => 288, {1, 12} => 192,
    {1, 15} => 288, {1, 18} => 448, {1, 21} => 320, {1, 24} => 272,
    {1, 30} => 576, {1, 36} => 1152, {1, 42} => 768, {1, 48} => 512,

    # Waveform 2 - BPSK
    {2, 3} => 48, {2, 6} => 96, {2, 9} => 288, {2, 12} => 192,
    {2, 15} => 288, {2, 18} => 448, {2, 21} => 320, {2, 24} => 272,
    {2, 30} => 576, {2, 36} => 1152, {2, 42} => 768, {2, 48} => 512,

    # Waveform 3 - BPSK
    {3, 3} => 96, {3, 6} => 204, {3, 9} => 288, {3, 12} => 384,
    {3, 15} => 288, {3, 18} => 448, {3, 21} => 320, {3, 24} => 816,
    {3, 30} => 576, {3, 36} => 1152, {3, 42} => 768, {3, 48} => 512,

    # Waveform 4 - BPSK
    {4, 3} => 96, {4, 6} => 204, {4, 12} => 384,
    {4, 15} => 288, {4, 21} => 320, {4, 24} => 816,
    {4, 30} => 576, {4, 48} => 512,

    # Waveform 5 - QPSK
    {5, 3} => 256, {5, 6} => 544, {5, 9} => 768, {5, 12} => 1024,
    {5, 15} => 1280, {5, 18} => 1536, {5, 21} => 1344, {5, 24} => 2176,
    {5, 30} => 2560, {5, 36} => 3072, {5, 42} => 3456, {5, 48} => 2560,

    # Waveform 6 - 8PSK
    {6, 3} => 256, {6, 6} => 544, {6, 9} => 768, {6, 12} => 1024,
    {6, 15} => 1280, {6, 18} => 1536, {6, 21} => 1344, {6, 24} => 2176,
    {6, 30} => 2560, {6, 36} => 3072, {6, 42} => 3456, {6, 48} => 2560,

    # Waveform 7 - 16QAM
    {7, 3} => 256, {7, 6} => 544, {7, 9} => 768, {7, 12} => 1024,
    {7, 15} => 1280, {7, 18} => 1536, {7, 21} => 1344, {7, 24} => 2176,
    {7, 30} => 2560, {7, 36} => 3072, {7, 42} => 3456, {7, 48} => 2560,

    # Waveform 8 - 32QAM
    {8, 3} => 256, {8, 6} => 544, {8, 9} => 768, {8, 12} => 1024,
    {8, 15} => 1280, {8, 18} => 1536, {8, 21} => 1344, {8, 24} => 2176,
    {8, 30} => 2560, {8, 36} => 3072, {8, 42} => 3456, {8, 48} => 2560,

    # Waveform 9 - 64QAM
    {9, 3} => 256, {9, 6} => 544, {9, 9} => 768, {9, 12} => 1024,
    {9, 15} => 1280, {9, 18} => 1536, {9, 21} => 1344, {9, 24} => 2176,
    {9, 30} => 2560, {9, 36} => 3072, {9, 42} => 3456, {9, 48} => 2560,

    # Waveform 10 - 64QAM
    {10, 3} => 256, {10, 6} => 544, {10, 9} => 768, {10, 12} => 1024,
    {10, 15} => 1280, {10, 18} => 1536, {10, 21} => 1344, {10, 24} => 2176,
    {10, 30} => 2560, {10, 36} => 3072, {10, 42} => 3456, {10, 48} => 2560,

    # Waveform 11 - 256QAM
    {11, 3} => 360, {11, 6} => 540, {11, 9} => 1080, {11, 12} => 1080,
    {11, 15} => 1152, {11, 18} => 1920, {11, 21} => 2560, {11, 24} => 1920,
    {11, 30} => 2700, {11, 36} => 3240, {11, 42} => 3840, {11, 48} => 2880,

    # Waveform 12 - QPSK
    {12, 3} => 360, {12, 6} => 540, {12, 9} => 1080, {12, 12} => 1080,
    {12, 15} => 1152, {12, 18} => 1920, {12, 21} => 2560, {12, 24} => 1920,
    {12, 30} => 2700, {12, 36} => 3240, {12, 42} => 3840, {12, 48} => 2880
  }

  @doc "Number of unknown (data) symbols per frame"
  def data_symbols(waveform, bw_khz), do: Map.fetch!(@data_symbols, {waveform, bw_khz})

  # ===========================================================================
  # Table D-XII: Known Symbols (Mini-Probe) per Frame (K)
  # ===========================================================================

  @probe_symbols %{
    # Waveform 1 - BPSK
    {1, 3} => 48, {1, 6} => 96, {1, 9} => 144, {1, 12} => 192,
    {1, 15} => 192, {1, 18} => 224, {1, 21} => 240, {1, 24} => 272,
    {1, 30} => 384, {1, 36} => 576, {1, 42} => 576, {1, 48} => 512,

    # Waveform 2 - BPSK
    {2, 3} => 48, {2, 6} => 96, {2, 9} => 144, {2, 12} => 192,
    {2, 15} => 192, {2, 18} => 224, {2, 21} => 240, {2, 24} => 272,
    {2, 30} => 384, {2, 36} => 576, {2, 42} => 576, {2, 48} => 512,

    # Waveform 3 - BPSK
    {3, 3} => 32, {3, 6} => 68, {3, 9} => 144, {3, 12} => 128,
    {3, 15} => 192, {3, 18} => 224, {3, 21} => 240, {3, 24} => 272,
    {3, 30} => 384, {3, 36} => 576, {3, 42} => 576, {3, 48} => 512,

    # Waveform 4 - BPSK
    {4, 3} => 32, {4, 6} => 68, {4, 12} => 128,
    {4, 15} => 192, {4, 21} => 240, {4, 24} => 272,
    {4, 30} => 384, {4, 48} => 512,

    # Waveform 5 - QPSK
    {5, 3} => 32, {5, 6} => 68, {5, 9} => 96, {5, 12} => 128,
    {5, 15} => 160, {5, 18} => 192, {5, 21} => 224, {5, 24} => 272,
    {5, 30} => 320, {5, 36} => 384, {5, 42} => 576, {5, 48} => 512,

    # Waveform 6 - 8PSK
    {6, 3} => 32, {6, 6} => 68, {6, 9} => 96, {6, 12} => 128,
    {6, 15} => 160, {6, 18} => 192, {6, 21} => 224, {6, 24} => 272,
    {6, 30} => 320, {6, 36} => 384, {6, 42} => 576, {6, 48} => 512,

    # Waveform 7 - 16QAM
    {7, 3} => 32, {7, 6} => 68, {7, 9} => 96, {7, 12} => 128,
    {7, 15} => 160, {7, 18} => 192, {7, 21} => 224, {7, 24} => 272,
    {7, 30} => 320, {7, 36} => 384, {7, 42} => 576, {7, 48} => 512,

    # Waveform 8 - 32QAM
    {8, 3} => 32, {8, 6} => 68, {8, 9} => 96, {8, 12} => 128,
    {8, 15} => 160, {8, 18} => 192, {8, 21} => 224, {8, 24} => 272,
    {8, 30} => 320, {8, 36} => 384, {8, 42} => 576, {8, 48} => 512,

    # Waveform 9 - 64QAM
    {9, 3} => 32, {9, 6} => 68, {9, 9} => 96, {9, 12} => 128,
    {9, 15} => 160, {9, 18} => 192, {9, 21} => 224, {9, 24} => 272,
    {9, 30} => 320, {9, 36} => 384, {9, 42} => 576, {9, 48} => 512,

    # Waveform 10 - 64QAM
    {10, 3} => 32, {10, 6} => 68, {10, 9} => 96, {10, 12} => 128,
    {10, 15} => 160, {10, 18} => 192, {10, 21} => 224, {10, 24} => 272,
    {10, 30} => 320, {10, 36} => 384, {10, 42} => 576, {10, 48} => 512,

    # Waveform 11 - 256QAM
    {11, 3} => 24, {11, 6} => 36, {11, 9} => 72, {11, 12} => 72,
    {11, 15} => 128, {11, 18} => 128, {11, 21} => 128, {11, 24} => 128,
    {11, 30} => 180, {11, 36} => 216, {11, 42} => 192, {11, 48} => 192,

    # Waveform 12 - QPSK
    {12, 3} => 24, {12, 6} => 36, {12, 9} => 72, {12, 12} => 72,
    {12, 15} => 128, {12, 18} => 128, {12, 21} => 128, {12, 24} => 128,
    {12, 30} => 180, {12, 36} => 216, {12, 42} => 192, {12, 48} => 192
  }

  @doc "Number of known (mini-probe) symbols per frame"
  def probe_symbols(waveform, bw_khz), do: Map.fetch!(@probe_symbols, {waveform, bw_khz})

  @doc "Total frame length (data + probe)"
  def frame_length(waveform, bw_khz) do
    data_symbols(waveform, bw_khz) + probe_symbols(waveform, bw_khz)
  end

  # ===========================================================================
  # Table D-XIV: Walsh Sequences for Preamble
  # ===========================================================================

  @walsh_sequences %{
    0 => [0, 0, 0, 0],  # di-bit 00
    1 => [0, 4, 0, 4],  # di-bit 01
    2 => [0, 0, 4, 4],  # di-bit 10
    3 => [0, 4, 4, 0]   # di-bit 11
  }

  @doc "4-element Walsh sequence for di-bit (0-3)"
  def walsh_sequence(dibit), do: Map.fetch!(@walsh_sequences, dibit)

  # ===========================================================================
  # Table D-XVIII: Fixed/TLC PN Sequence (256 symbols)
  # ===========================================================================

  @fixed_pn [
    6,5,1,0,7,1,0,1,0,5,3,5,2,2,4,5,4,0,6,4,1,4,0,3,3,0,0,3,3,7,3,4,
    2,4,0,0,6,2,1,4,6,1,0,5,7,3,4,1,2,6,1,7,0,7,3,2,2,2,3,2,4,6,3,6,
    6,3,7,5,4,7,5,6,7,4,0,2,6,1,5,3,0,4,2,4,6,4,5,2,5,4,5,3,1,5,4,5,
    2,7,4,4,4,0,3,4,7,6,4,2,6,2,0,3,5,3,2,2,4,5,2,0,0,3,5,0,3,2,6,6,
    1,4,2,3,6,1,3,0,3,3,2,4,2,2,6,5,5,3,6,7,6,5,6,6,5,2,5,4,2,3,3,3,
    5,7,5,5,3,7,0,4,7,0,4,1,6,2,3,5,5,6,2,6,4,6,3,4,0,7,0,0,5,2,1,5,
    4,3,4,5,7,0,5,3,7,6,6,6,4,5,6,0,2,0,4,2,3,4,4,0,7,6,6,2,0,0,3,3,
    0,5,2,4,2,2,4,5,4,6,6,6,3,2,1,0,3,2,6,0,6,2,4,0,6,4,1,3,3,5,3,6
  ]

  @doc "Fixed/TLC PN sequence (256 8-PSK symbols)"
  def fixed_pn, do: @fixed_pn

  # ===========================================================================
  # Table D-XIX: Count PN Sequence (256 symbols)
  # ===========================================================================

  @count_pn [
    5,5,2,2,0,2,5,6,7,1,3,5,1,5,6,5,3,7,0,4,0,3,3,2,1,3,0,3,1,6,2,6,
    0,6,4,1,2,5,6,3,5,3,7,4,2,6,7,3,0,2,0,1,7,5,0,6,1,5,0,3,2,2,5,2,
    5,2,3,4,2,7,6,1,1,5,2,1,5,4,0,3,5,5,0,3,1,4,0,5,0,3,0,6,0,0,3,1,
    6,1,4,4,7,7,0,5,7,0,1,5,1,0,1,3,1,5,0,7,1,2,2,2,7,1,2,5,0,3,3,2,
    2,0,4,5,1,3,1,3,5,3,1,7,5,2,7,1,3,1,5,6,2,4,6,0,6,1,0,0,3,6,2,7,
    3,2,4,7,6,4,1,3,6,6,0,3,0,0,7,5,4,5,1,2,1,5,0,3,1,0,4,6,6,1,0,5,
    2,6,3,2,7,4,2,4,0,1,7,0,7,0,5,1,4,5,7,2,0,4,4,3,5,2,7,7,4,5,1,4,
    4,6,3,3,0,5,1,5,5,4,3,2,0,3,0,4,7,4,5,1,5,5,7,7,6,2,4,3,5,2,2,4
  ]

  @doc "Count PN sequence (256 8-PSK symbols)"
  def count_pn, do: @count_pn

  # ===========================================================================
  # Table D-XX: WID PN Sequence (256 symbols)
  # ===========================================================================

  @wid_pn [
    2,3,0,3,7,3,3,0,1,4,4,6,5,5,4,5,6,2,0,5,6,6,5,3,5,5,2,2,1,2,3,6,
    1,1,4,3,1,0,5,1,0,3,3,0,3,0,4,4,6,2,5,6,1,7,2,6,2,0,0,4,7,2,3,5,
    2,7,1,6,5,0,4,1,6,2,1,5,4,3,5,0,3,4,1,3,2,1,6,1,5,7,0,4,7,6,6,0,
    4,7,6,6,6,6,2,3,5,0,7,0,3,1,5,1,2,0,5,3,2,4,5,6,6,7,7,3,5,1,6,0,
    1,4,4,5,6,0,6,7,2,4,4,0,3,7,2,0,0,1,4,0,7,1,7,4,5,4,5,5,5,3,3,2,
    0,5,1,3,1,5,3,4,1,5,4,1,4,4,2,2,4,3,0,7,4,1,5,7,1,4,7,2,5,5,6,6,
    1,6,5,6,3,0,2,5,7,7,4,4,3,4,4,6,0,7,2,2,0,0,2,1,0,0,3,6,6,4,0,2,
    4,3,4,5,2,6,3,7,7,5,7,3,0,7,0,0,7,2,6,2,2,6,1,4,3,7,6,5,0,6,5,4
  ]

  @doc "WID PN sequence (256 8-PSK symbols)"
  def wid_pn, do: @wid_pn

  # ===========================================================================
  # Table D-XXI: Mini-Probe Lengths and Cyclic Shifts
  # ===========================================================================

  # {probe_length} => {base_length, cyclic_shift}
  @mini_probe_params %{
    24 => {13, 6},
    32 => {16, 8},
    36 => {19, 9},
    48 => {25, 12},
    68 => {36, 18},
    72 => {36, 18},
    96 => {49, 24},
    128 => {64, 32},
    144 => {81, 40},
    160 => {81, 40},
    180 => {100, 50},
    192 => {100, 50},
    216 => {121, 60},
    224 => {121, 60},
    240 => {121, 60},
    272 => {144, 72},
    320 => {169, 85},
    384 => {196, 98},
    512 => {256, 128},
    576 => {289, 145}
  }

  @doc "Get {base_length, cyclic_shift} for a mini-probe length"
  def mini_probe_params(length), do: Map.fetch!(@mini_probe_params, length)

  # ===========================================================================
  # Waveform Modulation Types
  # ===========================================================================

  @modulations %{
    0 => :walsh,
    1 => :bpsk,
    2 => :bpsk,
    3 => :bpsk,
    4 => :bpsk,
    5 => :qpsk,
    6 => :psk8,
    7 => :qam16,
    8 => :qam32,
    9 => :qam64,
    10 => :qam64,
    11 => :qam256,
    12 => :qpsk
  }

  @doc "Modulation type for waveform number"
  def modulation(waveform), do: Map.fetch!(@modulations, waveform)

  @bits_per_symbol %{
    walsh: 1,  # special case
    bpsk: 1,
    qpsk: 2,
    psk8: 3,
    qam16: 4,
    qam32: 5,
    qam64: 6,
    qam256: 8
  }

  @doc "Bits per symbol for modulation type"
  def bits_per_symbol(mod), do: Map.fetch!(@bits_per_symbol, mod)

  # ===========================================================================
  # WID Encoding (Tables D-XV, D-XVI, D-XVII)
  # ===========================================================================

  @doc "Encode waveform ID fields into 5 di-bits with checksum"
  def encode_wid(waveform, interleaver, constraint_length) do
    # d9-d6: waveform number (4 bits)
    # d5-d4: interleaver (2 bits)
    # d3: constraint length (1 bit)
    # d2-d0: checksum (3 bits)

    d9_d6 = waveform &&& 0x0F
    d5_d4 = interleaver_to_bits(interleaver)
    d3 = if constraint_length == 9, do: 1, else: 0

    # Extract individual bits
    d9 = (d9_d6 >>> 3) &&& 1
    d8 = (d9_d6 >>> 2) &&& 1
    d7 = (d9_d6 >>> 1) &&& 1
    d6 = d9_d6 &&& 1
    d5 = (d5_d4 >>> 1) &&& 1
    d4 = d5_d4 &&& 1

    # Calculate checksum using bxor
    d2 = bxor(d9, bxor(d8, d7))
    d1 = bxor(d7, bxor(d6, d5))
    d0 = bxor(d5, bxor(d4, d3))

    # Return as 5 di-bits: w4, w3, w2, w1, w0
    [
      (d9 <<< 1) ||| d8,      # w4
      (d7 <<< 1) ||| d6,      # w3
      (d5 <<< 1) ||| d4,      # w2
      (d3 <<< 1) ||| d2,      # w1
      (d1 <<< 1) ||| d0       # w0
    ]
  end

  defp interleaver_to_bits(:ultra_short), do: 0
  defp interleaver_to_bits(:short), do: 1
  defp interleaver_to_bits(:medium), do: 2
  defp interleaver_to_bits(:long), do: 3

  # ===========================================================================
  # Downcount Encoding
  # ===========================================================================

  @doc "Encode downcount value (0 to 31) into 4 di-bits with parity"
  def encode_downcount(count) when count >= 0 and count <= 31 do
    # count = b4 b3 b2 b1 b0
    b0 = count &&& 1
    b1 = (count >>> 1) &&& 1
    b2 = (count >>> 2) &&& 1
    b3 = (count >>> 3) &&& 1
    b4 = (count >>> 4) &&& 1

    # Parity bits using bxor
    b7 = bxor(b1, bxor(b2, b3))
    b6 = bxor(b2, bxor(b3, b4))
    b5 = bxor(b0, bxor(b1, b2))

    # Pack into 4 di-bits: c3, c2, c1, c0
    [
      (b7 <<< 1) ||| b6,  # c3
      (b5 <<< 1) ||| b4,  # c2
      (b3 <<< 1) ||| b2,  # c1
      (b1 <<< 1) ||| b0   # c0
    ]
  end
end
